<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEFR Passage Analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;600;700&family=Libre+Franklin:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root {
            --a1-color: #d1fae5;
            --a1-text: #065f46;
            --a2-color: #a7f3d0;
            --a2-text: #064e3b;
            --b1-color: #fef3c7;
            --b1-text: #92400e;
            --b2-color: #fcd34d;
            --b2-text: #78350f;
            --c1-color: #fca5a5;
            --c1-text: #7f1d1d;
            --c2-color: #c084fc;
            --c2-text: #3b0764;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        header { text-align: center; margin-bottom: 40px; }
        h1 { font-size: 2.25rem; font-weight: 800; color: #111827; margin: 0; letter-spacing: -0.025em; }
        h1 span { color: var(--primary); }
        h2 { font-size: 1.25rem; font-weight: 600; color: #374151; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }

        .section {
            margin-bottom: 35px;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            background: #f9fafb;
            transition: transform 0.2s ease;
        }
        .section:hover { border-color: #d1d5db; }

        .file-upload-wrapper { position: relative; text-align: center; }
        .file-upload-label {
            display: block; padding: 30px; border: 2px dashed #cbd5e1;
            border-radius: 12px; background: white; cursor: pointer; transition: all 0.3s ease;
        }
        .file-upload-label:hover { border-color: var(--primary); background: #eef2ff; }
        .file-upload-icon { font-size: 2rem; margin-bottom: 10px; display: block; color: var(--text-muted); }
        input[type="file"] { display: none; }

        .format-instruction {
            margin-top: 15px; font-size: 0.9rem; color: var(--text-muted);
            background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary);
        }
        .code-block {
            display: block; font-family: 'Monaco', 'Consolas', monospace;
            background: #f1f5f9; padding: 10px; margin-top: 8px;
            border-radius: 6px; color: #334155; font-size: 0.85rem;
        }

        textarea {
            width: 100%; height: 180px; padding: 15px;
            border: 1px solid #d1d5db; border-radius: 12px;
            resize: vertical; font-family: inherit; font-size: 1rem;
            box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s;
        }
        textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

        .btn-group { display: flex; gap: 15px; margin-top: 20px; }
        button {
            padding: 12px 24px; border: none; border-radius: 8px;
            cursor: pointer; font-weight: 600; font-size: 1rem;
            transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-analyze {
            background-color: var(--primary); color: white; flex: 2;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.4);
        }
        .btn-analyze:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        .btn-clear { background-color: white; color: var(--text-muted); border: 1px solid #d1d5db; flex: 1; }
        .btn-clear:hover { background-color: #f3f4f6; color: #111827; }

        #output-area { display: none; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .highlighted-text {
            font-size: 1.1rem; line-height: 1.9; padding: 25px;
            background: white; border: 1px solid #e5e7eb; border-radius: 12px;
            white-space: pre-wrap; margin-bottom: 25px;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.02);
        }

        .cefr-word {
            padding: 2px 6px; border-radius: 4px; font-weight: 500;
            margin: 0 1px; position: relative; cursor: default; transition: filter 0.2s;
        }
        .cefr-word:hover { filter: brightness(0.95); }
        .cefr-word:hover::after {
            content: attr(data-info); position: absolute; bottom: 120%; left: 50%;
            transform: translateX(-50%); background: #1f2937; color: white;
            padding: 6px 10px; border-radius: 6px; font-size: 0.75rem;
            white-space: nowrap; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            pointer-events: none;
        }
        .cefr-word:hover::before {
            content: ''; position: absolute; bottom: 110%; left: 50%;
            transform: translateX(-50%); border-width: 5px; border-style: solid;
            border-color: #1f2937 transparent transparent transparent; z-index: 100;
        }

        .level-A1 { background-color: var(--a1-color); color: var(--a1-text); border-bottom: 2px solid #6ee7b7; }
        .level-A2 { background-color: var(--a2-color); color: var(--a2-text); border-bottom: 2px solid #34d399; }
        .level-B1 { background-color: var(--b1-color); color: var(--b1-text); border-bottom: 2px solid #fcd34d; }
        .level-B2 { background-color: var(--b2-color); color: var(--b2-text); border-bottom: 2px solid #f59e0b; }
        .level-C1 { background-color: var(--c1-color); color: var(--c1-text); border-bottom: 2px solid #ef4444; }
        .level-C2 { background-color: var(--c2-color); color: var(--c2-text); border-bottom: 2px solid #a855f7; }
        .level-XX { color: #4b5563; }

        .treemap-section { margin-bottom: 25px; }
        .treemap-header {
            display: flex; align-items: baseline; gap: 12px; margin-bottom: 14px;
        }
        .treemap-total-value {
            font-size: 2.4rem; font-weight: 800; color: #111827; line-height: 1;
        }
        .treemap-total-label {
            font-size: 0.82rem; text-transform: uppercase; letter-spacing: 0.06em;
            color: var(--text-muted); font-weight: 600;
        }
        .treemap-container {
            position: relative; width: 100%; height: 310px;
            border-radius: 14px; overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb; background: #ffffff;
        }
        .treemap-cell {
            position: absolute; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            box-sizing: border-box; border: 2px solid #ffffff;
            cursor: default; overflow: hidden;
            padding: 10px 8px;
            gap: 3px;
            opacity: 0; transform: scale(0.92);
            animation: treemapCellIn 0.45s ease-out forwards;
            transition: filter 0.2s ease, box-shadow 0.2s ease;
        }
        .treemap-cell:hover {
            filter: brightness(0.91) saturate(1.15);
            box-shadow: inset 0 0 0 2px rgba(0,0,0,0.08), 0 6px 16px rgba(0,0,0,0.12);
            z-index: 10;
        }
        @keyframes treemapCellIn {
            from { opacity: 0; transform: scale(0.92); }
            to   { opacity: 1; transform: scale(1); }
        }
        .treemap-cell-level {
            font-size: 0.72rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.08em; opacity: 0.6; line-height: 1;
        }
        .treemap-cell-count {
            font-size: 1.65rem; font-weight: 800; line-height: 1.15;
        }
        .treemap-cell-percent {
            font-size: 0.76rem; font-weight: 600; opacity: 0.7; line-height: 1;
        }
        .treemap-cell.size-lg .treemap-cell-level  { font-size: 0.82rem; }
        .treemap-cell.size-lg .treemap-cell-count   { font-size: 2.1rem; }
        .treemap-cell.size-lg .treemap-cell-percent  { font-size: 0.85rem; }
        .treemap-cell.size-md .treemap-cell-level  { font-size: 0.72rem; }
        .treemap-cell.size-md .treemap-cell-count   { font-size: 1.35rem; }
        .treemap-cell.size-md .treemap-cell-percent  { font-size: 0.72rem; }
        .treemap-cell.size-sm .treemap-cell-level  { font-size: 0.62rem; }
        .treemap-cell.size-sm .treemap-cell-count   { font-size: 1rem; }
        .treemap-cell.size-sm .treemap-cell-percent  { font-size: 0.62rem; }
        .treemap-cell.size-sm { padding: 6px 5px; gap: 2px; }
        .treemap-cell.size-xs .treemap-cell-level  { font-size: 0.58rem; letter-spacing: 0.04em; }
        .treemap-cell.size-xs .treemap-cell-count   { font-size: 0.82rem; }
        .treemap-cell.size-xs .treemap-cell-percent  { display: none; }
        .treemap-cell.size-xs { padding: 4px 4px; gap: 1px; }
        .treemap-cell.size-xxs .treemap-cell-level  { font-size: 0.52rem; }
        .treemap-cell.size-xxs .treemap-cell-count   { font-size: 0.72rem; }
        .treemap-cell.size-xxs .treemap-cell-percent { display: none; }
        .treemap-cell.size-xxs { padding: 2px 3px; gap: 1px; }
        .treemap-cell.size-dot .treemap-cell-level   { font-size: 0.5rem; }
        .treemap-cell.size-dot .treemap-cell-count    { display: none; }
        .treemap-cell.size-dot .treemap-cell-percent  { display: none; }
        .treemap-cell.size-dot { padding: 1px 2px; gap: 0; }

        .treemap-tooltip {
            position: fixed; padding: 8px 14px; background: #1f2937; color: #fff;
            border-radius: 8px; font-size: 0.8rem; font-weight: 600;
            pointer-events: none; z-index: 1000; white-space: nowrap;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            opacity: 0; transition: opacity 0.15s ease;
        }
        .treemap-tooltip.visible { opacity: 1; }

        .verdict-box {
            background: linear-gradient(to right, #eff6ff, #ffffff);
            border-left: 6px solid var(--primary); padding: 25px;
            border-radius: 0 12px 12px 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .verdict-title { font-weight: 700; font-size: 1.2rem; display: block; margin-bottom: 10px; color: #1e3a8a; }
        .verdict-disclaimer {
            margin-top: 18px; padding: 12px 16px; background: #fef9ee; border: 1px solid #f5d990;
            border-radius: 8px; font-size: 0.82rem; color: #92400e; line-height: 1.55;
            display: flex; align-items: flex-start; gap: 8px;
        }
        .verdict-disclaimer svg { flex-shrink: 0; margin-top: 1px; }

        .word-lists-wrapper { margin-top: 30px; }
        .word-lists-title {
            font-size: 1.25rem; font-weight: 700; color: #111827; margin-bottom: 20px;
            display: flex; align-items: center; gap: 10px;
        }
        .word-level-block {
            margin-bottom: 22px; border-radius: 14px; overflow: hidden;
            border: 1px solid var(--border-color); background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .word-level-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 20px; font-weight: 700; font-size: 0.95rem; letter-spacing: 0.02em;
        }
        .word-level-header .level-badge {
            display: inline-flex; align-items: center; gap: 8px;
        }
        .word-level-header .level-badge .badge-dot {
            width: 12px; height: 12px; border-radius: 50%; display: inline-block;
        }
        .word-level-header .word-count-tag {
            font-size: 0.75rem; font-weight: 600; padding: 3px 10px;
            border-radius: 20px; background: rgba(0,0,0,0.06); color: inherit;
        }
        .word-level-header-B1 { background: linear-gradient(135deg, #fefce8, #fef3c7); color: var(--b1-text); border-bottom: 2px solid #fcd34d; }
        .word-level-header-B2 { background: linear-gradient(135deg, #fffbeb, #fef3c7); color: var(--b2-text); border-bottom: 2px solid #f59e0b; }
        .word-level-header-C1 { background: linear-gradient(135deg, #fef2f2, #fee2e2); color: var(--c1-text); border-bottom: 2px solid #ef4444; }
        .word-level-header-C2 { background: linear-gradient(135deg, #faf5ff, #f3e8ff); color: var(--c2-text); border-bottom: 2px solid #a855f7; }
        .word-level-body {
            padding: 16px 20px; display: flex; flex-wrap: wrap; gap: 8px 12px;
            max-height: 280px; overflow-y: auto;
        }
        .word-level-body::-webkit-scrollbar { width: 6px; }
        .word-level-body::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .word-chip {
            display: inline-block; padding: 4px 12px; border-radius: 6px;
            font-size: 0.88rem; font-weight: 500; background: #f9fafb;
            border: 1px solid #e5e7eb; color: #374151; line-height: 1.5;
            transition: background 0.15s, border-color 0.15s;
            cursor: pointer; user-select: none;
        }
        .word-chip:hover { background: #eef2ff; border-color: #a5b4fc; color: #4338ca; }

        .cefr-word.jump-highlight {
            outline: 3px solid #6366f1;
            outline-offset: 2px;
            border-radius: 4px;
            animation: jumpPulse 1.5s ease-out;
        }
        @keyframes jumpPulse {
            0% { outline-color: #6366f1; box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.5); }
            50% { outline-color: #6366f1; box-shadow: 0 0 12px 4px rgba(99, 102, 241, 0.3); }
            100% { outline-color: transparent; box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        .word-chip .pos-tag {
            font-size: 0.76rem; color: #9ca3af; font-weight: 400; margin-left: 2px;
        }
        .copy-btn {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 6px 14px; border-radius: 6px; border: 1px solid #d1d5db;
            background: white; color: #6b7280; font-size: 0.8rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .copy-btn:hover { background: #f3f4f6; color: #374151; border-color: #9ca3af; }
        .copy-btn.copied { background: #ecfdf5; color: #059669; border-color: #6ee7b7; }
        .copy-btn svg { width: 14px; height: 14px; }

        .legend { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; font-size: 0.85rem; justify-content: flex-end; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-weight: 500; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

        @media (max-width: 600px) {
            body { padding: 20px 10px; }
            .container { padding: 20px; }
            .btn-group { flex-direction: column; }
            h1 { font-size: 1.75rem; }
            .treemap-container { height: 240px; }
        }
        .brand-header {
            text-align: center;
            padding: 28px 20px 22px;
            margin-bottom: 0;
        }
        .brand-header .brand-name {
            font-family: 'Bricolage Grotesque', sans-serif;
            font-weight: 700;
            font-size: 1.65rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: #ffffff;
            margin: 0;
            text-shadow: 0 1px 4px rgba(0,0,0,0.18);
        }
        .brand-header .brand-accent {
            display: block;
            width: 36px;
            height: 2px;
            background: rgba(255,255,255,0.55);
            margin: 10px auto 0;
            border-radius: 2px;
        }
        .site-footer {
            text-align: center;
            padding: 24px 20px 10px;
            margin-top: 0;
        }
        .site-footer p {
            font-family: 'Libre Franklin', 'Inter', sans-serif;
            font-weight: 300;
            font-size: 0.78rem;
            color: rgba(255,255,255,0.6);
            letter-spacing: 0.06em;
            margin: 0;
        }
    </style>
</head>
<body>

<div class="brand-header">
    <p class="brand-name">K S Lo English</p>
    <span class="brand-accent"></span>
</div>

<div class="container">
    <header>
        <h1>CEFR <span>Text Analyzer</span></h1>
        <p style="color: var(--text-muted); margin-top: 10px;">Analyze text complexity using the pre-loaded Oxford 3000/5000 and Cambridge C2 word lists or other word lists.</p>
    </header>

    <div class="section">
        <h2>
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
            1. Data Source
        </h2>
        <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 1px solid #6ee7b7; border-radius: 12px; padding: 16px 20px; margin-bottom: 18px; display: flex; align-items: flex-start; gap: 12px;">
            <span style="font-size: 1.4rem; flex-shrink: 0; margin-top: 1px;">‚úÖ</span>
            <div>
                <strong style="color: #065f46; font-size: 0.95rem;">No action needed ‚Äî default word list is pre-loaded</strong>
                <p style="margin: 4px 0 0; color: #047857; font-size: 0.85rem; line-height: 1.5;">The <strong>Oxford 5000 + Cambridge C2</strong> word list is already loaded and ready to use. You can skip this step and go straight to Step 2. Only upload a CSV below if you want to use a different word list.</p>
            </div>
        </div>
        <details style="margin-top: 0;">
            <summary style="cursor: pointer; font-size: 0.9rem; color: var(--primary); font-weight: 600; padding: 6px 0; user-select: none;">Want to use a custom word list instead? Click here to upload a CSV</summary>
            <div style="margin-top: 12px;">
                <div class="file-upload-wrapper">
                    <label for="csvFile" class="file-upload-label" id="file-label">
                        <span class="file-upload-icon">üìÑ</span>
                        <span id="file-text"><strong>Click to upload CSV</strong> or drag and drop</span>
                        <span id="file-hint" style="display:block;margin-top:8px;font-size:0.8rem;color:#9ca3af;">This will replace the pre-loaded default word list</span>
                    </label>
                    <input type="file" id="csvFile" accept=".csv">
                </div>
                <div class="format-instruction">
                    <strong>Required CSV format:</strong> Each row should contain
                    <code class="code-block">CEFR,Word,Part of Speech<br>Example: B2,navigate,v</code>
                </div>
            </div>
        </details>
        <div id="file-status" style="margin-top: 10px; font-size: 0.9rem; color: #059669; font-weight: 600; text-align: center;"></div>
    </div>

    <div class="section">
        <h2>
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
            2. Reading Passage
        </h2>
        <textarea id="inputText" placeholder="Paste the text you want to analyze here..."></textarea>
        <div class="btn-group">
            <button class="btn-analyze" onclick="analyzePassage()">Analyze Text</button>
            <button class="btn-clear" onclick="clearAll()">Clear All</button>
        </div>
    </div>

    <div id="output-area" class="section" style="border-color: var(--primary);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                3. Analysis Results
            </h2>
            <div class="legend">
                <div class="legend-item"><span class="dot" style="background:var(--a1-color)"></span> A1</div>
                <div class="legend-item"><span class="dot" style="background:var(--a2-color)"></span> A2</div>
                <div class="legend-item"><span class="dot" style="background:var(--b1-color)"></span> B1</div>
                <div class="legend-item"><span class="dot" style="background:var(--b2-color)"></span> B2</div>
                <div class="legend-item"><span class="dot" style="background:var(--c1-color)"></span> C1</div>
                <div class="legend-item"><span class="dot" style="background:var(--c2-color)"></span> C2</div>
            </div>
        </div>

        <div id="highlighted-content" class="highlighted-text"></div>

        <div class="treemap-section">
            <div class="treemap-header">
                <span class="treemap-total-value" id="count-total">0</span>
                <span class="treemap-total-label">Total Words</span>
            </div>
            <div class="treemap-container" id="treemap-container"></div>
        </div>

        <div class="verdict-box">
            <span class="verdict-title">Final Verdict</span>
            <p id="verdict-text" style="margin: 0; color: #374151;">Waiting for analysis...</p>
            <div class="verdict-disclaimer">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#92400e" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <span><strong>Disclaimer:</strong> This analysis and final verdict are generated algorithmically and are not 100% accurate. Results may contain incorrect information regarding word levels, text classification, or overall CEFR assessment. Please use this as a reference tool only and not as a definitive evaluation.</span>
            </div>
        </div>

        <div id="word-lists-area" class="word-lists-wrapper" style="display:none;">
            <h2 class="word-lists-title">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 10h16M4 14h10M4 18h7"/></svg>
                Word Lists
            </h2>
            <div id="word-lists-content"></div>
        </div>
    </div>
</div>

<div class="treemap-tooltip" id="treemap-tooltip"></div>

<script>
    let dictionary = new Map();
    let dictionaryWithPos = new Map();
    let isFileLoaded = false;

    const DEFAULT_CSV_URL = 'https://pfst.cf2.poecdn.net/base/text/11ce500d4f8d7a245d61f5d6c63092a32da19d4ff28b0f6b5f804a66b6e97d47';
    const DEFAULT_CSV_NAME = 'A1-C2.csv';

    const SUPPLEMENTARY_WORDS = new Map([
        ['email', 'A2'], ['emails', 'A2'], ['online', 'A2'], ['website', 'A2'],
        ['internet', 'A2'], ['computer', 'A1'], ['phone', 'A1'], ['video', 'A2'],
        ['app', 'A2'], ['apps', 'A2'], ['digital', 'B1'], ['wifi', 'A2'],
        ['laptop', 'A2'], ['smartphone', 'A2'], ['download', 'A2'], ['upload', 'B1'],
        ['click', 'A2'], ['username', 'A2'], ['password', 'A2'], ['login', 'A2'],
        ['library', 'A2'], ['exhibition', 'B1'], ['exhibitions', 'B1'],
        ['secretary', 'B1'], ['photography', 'B1'], ['photographer', 'B1'],
        ['photographers', 'B1'], ['photograph', 'B1'], ['photographs', 'B1'],
        ['artistic', 'B1'], ['portrait', 'B1'], ['portraits', 'B1'],
        ['landscape', 'B1'], ['landscapes', 'B1'], ['imagination', 'B1'],
        ['creative', 'B1'], ['creativity', 'B1'], ['gallery', 'B1'],
        ['presentation', 'B1'], ['presentations', 'B1'], ['certificate', 'B1'],
        ['homework', 'A1'], ['classroom', 'A1'], ['textbook', 'A2'],
        ['favourite', 'A1'], ['favorites', 'A1'], ['color', 'A1'], ['colour', 'A1'],
        ['center', 'A2'], ['centre', 'A2'], ['organize', 'B1'], ['organise', 'B1'],
        ['recognize', 'B1'], ['recognise', 'B1'], ['realize', 'B1'], ['realise', 'B1'],
        ['theater', 'A2'], ['theatre', 'A2'],
        ['neighbor', 'A2'], ['neighbour', 'A2'], ['behavior', 'B1'], ['behaviour', 'B1'],
        ['today', 'A1'], ['tomorrow', 'A1'], ['yesterday', 'A1'], ['tonight', 'A1'],
        ['weekend', 'A1'], ['weekday', 'A2'], ['everyday', 'A1'], ['sometime', 'A2'],
        ['sometimes', 'A1'], ['always', 'A1'], ['never', 'A1'], ['often', 'A1'],
        ['first', 'A1'], ['second', 'A1'], ['third', 'A1'], ['fourth', 'A1'],
        ['fifth', 'A1'], ['sixth', 'A1'], ['seventh', 'A2'], ['eighth', 'A2'],
        ['ninth', 'A2'], ['tenth', 'A2'], ['hundred', 'A1'], ['thousand', 'A1'],
        ['million', 'A2'], ['billion', 'B1'],
        ['who', 'A1'], ['what', 'A1'], ['where', 'A1'], ['when', 'A1'],
        ['why', 'A1'], ['how', 'A1'], ['which', 'A1'],
        ['everyone', 'A1'], ['everybody', 'A1'], ['everything', 'A1'],
        ['someone', 'A1'], ['somebody', 'A1'], ['something', 'A1'],
        ['anyone', 'A1'], ['anybody', 'A1'], ['anything', 'A1'],
        ['no one', 'A1'], ['nobody', 'A1'], ['nothing', 'A1'],
        ['gonna', 'A2'], ['wanna', 'A2'], ['gotta', 'A2'],
        ['also', 'A1'], ['too', 'A1'], ['either', 'A2'], ['neither', 'A2'],
        ['both', 'A1'], ['however', 'B1'], ['therefore', 'B2'], ['although', 'B1'],
        ['though', 'B1'], ['unless', 'B1'], ['whether', 'B1'], ['whereas', 'B2'],
        ['okay', 'A1'], ['ok', 'A1'], ['nice', 'A1'], ['great', 'A1'],
        ['good', 'A1'], ['bad', 'A1'], ['best', 'A1'], ['worst', 'A2'],
        ['better', 'A1'], ['worse', 'A2'],
        ['mom', 'A1'], ['dad', 'A1'], ['mum', 'A1'], ['mommy', 'A1'], ['daddy', 'A1'],
        ['grandma', 'A1'], ['grandpa', 'A1'], ['granny', 'A1'],
        ['kid', 'A1'], ['kids', 'A1'], ['guy', 'A2'], ['guys', 'A2'],
        ['stuff', 'A2'], ['thing', 'A1'], ['things', 'A1'],
        ['hello', 'A1'], ['hi', 'A1'], ['bye', 'A1'], ['goodbye', 'A1'],
        ['please', 'A1'], ['thanks', 'A1'], ['sorry', 'A1'], ['excuse', 'A1'],
        ['welcome', 'A1'], ['congratulations', 'A2'],
        ['breath', 'B1'], ['vote', 'B1'], ['votes', 'B1'],
        ['soar', 'B2'], ['soars', 'B2'], ['soaring', 'B2'],
        ['auntie', 'A2'], ['aunty', 'A2'],
        ['oyster', 'B2'], ['oysters', 'B2'],
        ['squid', 'B2'],
        ['shrimp', 'B1'],
        ['fisherman', 'B1'], ['fishermen', 'B1'],
        ['landlubber', 'C1'], ['landlubbers', 'C1'],
        ['delectable', 'C1'],
        // ‚òÖ ADDED: common simple words that should not inflate difficulty
        ['caf√©', 'A1'], ['cafe', 'A1'], ['pizza', 'A1'], ['chocolate', 'A1'],
        ['sightseeing', 'A2'], ['ice cream', 'A1'],
        ['holiday', 'A1'], ['holidays', 'A1']
    ]);

    const SPELLING_VARIANTS = new Map([
        ['colour', 'color'], ['colours', 'colors'], ['coloured', 'colored'], ['colouring', 'coloring'],
        ['favour', 'favor'], ['favours', 'favors'], ['favoured', 'favored'], ['favouring', 'favoring'],
        ['favourite', 'favorite'], ['favourites', 'favorites'],
        ['honour', 'honor'], ['honours', 'honors'], ['honoured', 'honored'], ['honouring', 'honoring'],
        ['labour', 'labor'], ['labours', 'labors'], ['laboured', 'labored'], ['labouring', 'laboring'],
        ['neighbour', 'neighbor'], ['neighbours', 'neighbors'], ['neighbouring', 'neighboring'],
        ['behaviour', 'behavior'], ['behaviours', 'behaviors'],
        ['flavour', 'flavor'], ['flavours', 'flavors'], ['flavoured', 'flavored'],
        ['humour', 'humor'], ['humours', 'humors'], ['humoured', 'humored'],
        ['centre', 'center'], ['centres', 'centers'], ['centred', 'centered'],
        ['theatre', 'theater'], ['theatres', 'theaters'],
        ['metre', 'meter'], ['metres', 'meters'],
        ['litre', 'liter'], ['litres', 'liters'],
        ['fibre', 'fiber'], ['fibres', 'fibers'],
        ['analyse', 'analyze'], ['analysed', 'analyzed'], ['analysing', 'analyzing'], ['analyses', 'analyzes'],
        ['organise', 'organize'], ['organised', 'organized'], ['organising', 'organizing'], ['organises', 'organizes'],
        ['realise', 'realize'], ['realised', 'realized'], ['realising', 'realizing'], ['realises', 'realizes'],
        ['recognise', 'recognize'], ['recognised', 'recognized'], ['recognising', 'recognizing'], ['recognises', 'recognizes'],
        ['apologise', 'apologize'], ['apologised', 'apologized'], ['apologising', 'apologizing'],
        ['criticise', 'criticize'], ['criticised', 'criticized'], ['criticising', 'criticizing'],
        ['emphasise', 'emphasize'], ['emphasised', 'emphasized'], ['emphasising', 'emphasizing'],
        ['specialise', 'specialize'], ['specialised', 'specialized'], ['specialising', 'specializing'],
        ['travelling', 'traveling'], ['travelled', 'traveled'], ['traveller', 'traveler'],
        ['cancelled', 'canceled'], ['cancelling', 'canceling'],
        ['modelling', 'modeling'], ['modelled', 'modeled'],
        ['labelling', 'labeling'], ['labelled', 'labeled'],
        ['jewellery', 'jewelry'], ['grey', 'gray'],
        ['programme', 'program'], ['programmes', 'programs'],
        ['catalogue', 'catalog'], ['catalogues', 'catalogs'],
        ['dialogue', 'dialog'], ['dialogues', 'dialogs'],
        ['defence', 'defense'], ['defences', 'defenses'],
        ['offence', 'offense'], ['offences', 'offenses'],
        ['licence', 'license'], ['licences', 'licenses'],
        ['practise', 'practice'], ['practised', 'practiced'], ['practising', 'practicing']
    ]);

    const PROPER_NOUNS = new Set([
        'timothy', 'cheung', 'james', 'john', 'mary', 'sarah', 'michael', 'jennifer',
        'david', 'lisa', 'robert', 'susan', 'william', 'jessica', 'richard', 'ashley',
        'michelle', 'obama', 'marian', 'robinson', 'fraser', 'craig', 'robbie',
        'harry', 'daisy', 'chan', 'atid', 'chai', 'omer', 'soker', 'zara',
        'barack', 'joe', 'biden', 'trump', 'hillary', 'clinton',
        'chicago', 'seoul', 'bangkok', 'thailand', 'korea', 'hong', 'kong', 'australia',
        'australian', 'america', 'american', 'english', 'british', 'chinese', 'japanese',
        'thai', 'korean', 'european', 'asian', 'african', 'york', 'london', 'paris',
        'united', 'states',
        'shein', 'temu', 'ebay', 'facebook', 'marketplace', 'anthropic', 'google',
        'amazon', 'apple', 'microsoft', 'netflix', 'spotify', 'instagram', 'twitter',
        'january', 'february', 'march', 'april', 'may', 'june', 'july', 'august',
        'september', 'october', 'november', 'december',
        'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday',
        'hung', 'wong', 'lo', 'lam', 'lee', 'tang', 'ho', 'ng', 'wu', 'liu',
        'chen', 'lin', 'leung', 'chow', 'tsang', 'yip', 'kwok', 'lau', 'fau',
        'shan', 'sai', 'tai', 'aberdeen', 'kowloon', 'tsim', 'tsui', 'mongkok',
        'yau', 'tei', 'shek', 'kip', 'mei', 'tung', 'wan', 'chai', 'pok',
        'fu', 'lam', 'tuen', 'mun', 'yuen', 'fanling', 'sheung', 'shui',
        // ‚òÖ ADDED: proper nouns for the "Hi Brian" text and similar travel letters
        'brian', 'cindy', 'rome', 'italy', 'italian', 'italians'
    ]);

    const LITERARY_VOCABULARY = new Set([
        'clipped', 'wry', 'witty', 'ornery', 'contentious', 'negligent', 'wholly',
        'durable', 'reverent', 'vicious', 'chastened', 'lawyerly', 'dictatorial',
        'unyielding', 'freewheeling', 'seething', 'arcane', 'feistiness', 'feisty',
        'buzzy', 'fumbling', 'intently', 'outright', 'unpurse', 'debuted',
        'wistful', 'melancholy', 'poignant', 'evocative', 'visceral', 'ethereal',
        'ephemeral', 'transcendent', 'sublime', 'austere', 'luminous', 'sassy',
        'infectious', 'limelight', 'scrapped', 'chide', 'bolster', 'recounted'
    ]);

    const IDIOM_PATTERNS = [
        { pattern: /rule the roost/gi, level: 'C1+', weight: 3 },
        { pattern: /chew(ed|ing|s)? (him|her|me|them|us|you) out/gi, level: 'C1+', weight: 3 },
        { pattern: /in (each other'?s?|one another'?s?) face(s)?/gi, level: 'C1+', weight: 2.5 },
        { pattern: /honeymoon phase/gi, level: 'C1', weight: 2.5 },
        { pattern: /crack(ed|ing|s)? up/gi, level: 'C1', weight: 2 },
        { pattern: /out of the corner of (my|his|her|their) eye/gi, level: 'C1', weight: 2 },
        { pattern: /laid? down (the )?(law|rules?)/gi, level: 'C1', weight: 2 },
        { pattern: /on[- ]and[- ]off/gi, level: 'B2', weight: 1.5 },
        { pattern: /let (it |that |this )?be/gi, level: 'B2', weight: 1.5 },
        { pattern: /on the face of it/gi, level: 'B2', weight: 1.5 },
        { pattern: /foot(ing|ed|s)? the bill/gi, level: 'B2', weight: 1.5 },
        { pattern: /think twice/gi, level: 'B2', weight: 1 },
        { pattern: /bear(ing|s)? the burden/gi, level: 'B2', weight: 1.5 },
        { pattern: /take(s)? (your |my |his |her |their )?breath away/gi, level: 'B2', weight: 1.5 },
        { pattern: /make(s)? (your |my |his |her |their )?(imagination |dreams? )?soar/gi, level: 'B2', weight: 1.5 },
        { pattern: /follow(ed|ing|s)? suit/gi, level: 'B2', weight: 1.5 },
        { pattern: /hit (up)?on/gi, level: 'B2', weight: 1 },
        { pattern: /close(d|s|ing)? up shop/gi, level: 'B2', weight: 1.5 },
        { pattern: /make(s|d|ing)? a living/gi, level: 'B1', weight: 0.5 },
        { pattern: /give(s|n)? (it |this |that )?up/gi, level: 'B1', weight: 0.5 }
    ];

    const FIGURATIVE_PATTERNS = [
        { pattern: /flame(s)? (inside|within|of)/gi, weight: 2 },
        { pattern: /keep (the |their |her |his |my )?flame lit/gi, weight: 2.5 },
        { pattern: /pour(ing|ed)? .{0,20} foundation/gi, weight: 2 },
        { pattern: /pulse of (something|anything)/gi, weight: 2 }
    ];

    const COMPLEX_SYNTAX_PATTERNS = [
        { pattern: /had I been/gi, weight: 2, type: 'subjunctive_inversion' },
        { pattern: /were (I|he|she|we|they) to/gi, weight: 2, type: 'subjunctive_inversion' },
        { pattern: /nor was (I|he|she|it)/gi, weight: 1.5, type: 'inversion' },
        { pattern: /not only .{5,50} but (also )?/gi, weight: 1, type: 'correlative' },
        { pattern: /, as .{5,40} would attest/gi, weight: 2, type: 'parenthetical_clause' },
        { pattern: / ‚Äì .{10,60} ‚Äì /g, weight: 1.5, type: 'dash_parenthetical' }
    ];

    const CONTRACTIONS = new Map([
        ["i'm", "be"], ["you're", "be"], ["he's", "be"], ["she's", "be"],
        ["it's", "be"], ["we're", "be"], ["they're", "be"], ["i've", "have"],
        ["you've", "have"], ["we've", "have"], ["they've", "have"],
        ["i'd", "would"], ["you'd", "would"], ["he'd", "would"], ["she'd", "would"],
        ["we'd", "would"], ["they'd", "would"], ["i'll", "will"], ["you'll", "will"],
        ["he'll", "will"], ["she'll", "will"], ["we'll", "will"], ["they'll", "will"],
        ["isn't", "be"], ["aren't", "be"], ["wasn't", "be"], ["weren't", "be"],
        ["haven't", "have"], ["hasn't", "have"], ["hadn't", "have"],
        ["won't", "will"], ["wouldn't", "would"], ["don't", "do"],
        ["doesn't", "do"], ["didn't", "do"], ["can't", "can"],
        ["couldn't", "could"], ["shouldn't", "should"], ["mightn't", "might"],
        ["mustn't", "must"], ["let's", "let"], ["that's", "that"],
        ["who's", "who"], ["what's", "what"], ["here's", "here"],
        ["there's", "there"], ["where's", "where"], ["how's", "how"]
    ]);

    const IRREGULAR_VERBS = new Map([
        ['was', 'be'], ['were', 'be'], ['been', 'be'], ['being', 'be'],
        ['had', 'have'], ['has', 'have'], ['having', 'have'],
        ['did', 'do'], ['does', 'do'], ['doing', 'do'], ['done', 'do'],
        ['went', 'go'], ['gone', 'go'], ['going', 'go'], ['goes', 'go'],
        ['came', 'come'], ['coming', 'come'], ['comes', 'come'],
        ['said', 'say'], ['saying', 'say'], ['says', 'say'],
        ['made', 'make'], ['making', 'make'], ['makes', 'make'],
        ['took', 'take'], ['taken', 'take'], ['taking', 'take'], ['takes', 'take'],
        ['got', 'get'], ['gotten', 'get'], ['getting', 'get'], ['gets', 'get'],
        ['gave', 'give'], ['given', 'give'], ['giving', 'give'], ['gives', 'give'],
        ['saw', 'see'], ['seen', 'see'], ['seeing', 'see'], ['sees', 'see'],
        ['knew', 'know'], ['known', 'know'], ['knowing', 'know'], ['knows', 'know'],
        ['thought', 'think'], ['thinking', 'think'], ['thinks', 'think'],
        ['told', 'tell'], ['telling', 'tell'], ['tells', 'tell'],
        ['found', 'find'], ['finding', 'find'], ['finds', 'find'],
        ['left', 'leave'], ['leaving', 'leave'], ['leaves', 'leave'],
        ['felt', 'feel'], ['feeling', 'feel'], ['feels', 'feel'],
        ['became', 'become'], ['becoming', 'become'], ['becomes', 'become'],
        ['began', 'begin'], ['begun', 'begin'], ['beginning', 'begin'], ['begins', 'begin'],
        ['kept', 'keep'], ['keeping', 'keep'], ['keeps', 'keep'],
        ['let', 'let'], ['letting', 'let'], ['lets', 'let'],
        ['put', 'put'], ['putting', 'put'], ['puts', 'put'],
        ['set', 'set'], ['setting', 'set'], ['sets', 'set'],
        ['sat', 'sit'], ['sitting', 'sit'], ['sits', 'sit'],
        ['stood', 'stand'], ['standing', 'stand'], ['stands', 'stand'],
        ['ran', 'run'], ['running', 'run'], ['runs', 'run'],
        ['wrote', 'write'], ['written', 'write'], ['writing', 'write'], ['writes', 'write'],
        ['read', 'read'], ['reading', 'read'], ['reads', 'read'],
        ['spoke', 'speak'], ['spoken', 'speak'], ['speaking', 'speak'], ['speaks', 'speak'],
        ['brought', 'bring'], ['bringing', 'bring'], ['brings', 'bring'],
        ['bought', 'buy'], ['buying', 'buy'], ['buys', 'buy'],
        ['caught', 'catch'], ['catching', 'catch'], ['catches', 'catch'],
        ['taught', 'teach'], ['teaching', 'teach'], ['teaches', 'teach'],
        ['built', 'build'], ['building', 'build'], ['builds', 'build'],
        ['sent', 'send'], ['sending', 'send'], ['sends', 'send'],
        ['spent', 'spend'], ['spending', 'spend'], ['spends', 'spend'],
        ['fell', 'fall'], ['fallen', 'fall'], ['falling', 'fall'], ['falls', 'fall'],
        ['held', 'hold'], ['holding', 'hold'], ['holds', 'hold'],
        ['led', 'lead'], ['leading', 'lead'], ['leads', 'lead'],
        ['lost', 'lose'], ['losing', 'lose'], ['loses', 'lose'],
        ['met', 'meet'], ['meeting', 'meet'], ['meets', 'meet'],
        ['paid', 'pay'], ['paying', 'pay'], ['pays', 'pay'],
        ['sold', 'sell'], ['selling', 'sell'], ['sells', 'sell'],
        ['understood', 'understand'], ['understanding', 'understand'], ['understands', 'understand'],
        ['wore', 'wear'], ['worn', 'wear'], ['wearing', 'wear'], ['wears', 'wear'],
        ['won', 'win'], ['winning', 'win'], ['wins', 'win'],
        ['broke', 'break'], ['broken', 'break'], ['breaking', 'break'], ['breaks', 'break'],
        ['chose', 'choose'], ['chosen', 'choose'], ['choosing', 'choose'], ['chooses', 'choose'],
        ['drove', 'drive'], ['driven', 'drive'], ['driving', 'drive'], ['drives', 'drive'],
        ['ate', 'eat'], ['eaten', 'eat'], ['eating', 'eat'], ['eats', 'eat'],
        ['flew', 'fly'], ['flown', 'fly'], ['flying', 'fly'], ['flies', 'fly'],
        ['forgot', 'forget'], ['forgotten', 'forget'], ['forgetting', 'forget'], ['forgets', 'forget'],
        ['grew', 'grow'], ['grown', 'grow'], ['growing', 'grow'], ['grows', 'grow'],
        ['hid', 'hide'], ['hidden', 'hide'], ['hiding', 'hide'], ['hides', 'hide'],
        ['lay', 'lie'], ['lain', 'lie'], ['lying', 'lie'], ['lies', 'lie'],
        ['laid', 'lay'], ['laying', 'lay'], ['lays', 'lay'],
        ['rose', 'rise'], ['risen', 'rise'], ['rising', 'rise'], ['rises', 'rise'],
        ['rode', 'ride'], ['ridden', 'ride'], ['riding', 'ride'], ['rides', 'ride'],
        ['sang', 'sing'], ['sung', 'sing'], ['singing', 'sing'], ['sings', 'sing'],
        ['swam', 'swim'], ['swum', 'swim'], ['swimming', 'swim'], ['swims', 'swim'],
        ['threw', 'throw'], ['thrown', 'throw'], ['throwing', 'throw'], ['throws', 'throw'],
        ['woke', 'wake'], ['woken', 'wake'], ['waking', 'wake'], ['wakes', 'wake'],
        ['children', 'child'], ['men', 'man'], ['women', 'woman'], ['people', 'person'],
        ['teeth', 'tooth'], ['feet', 'foot'], ['mice', 'mouse'], ['geese', 'goose'],
        ['lives', 'life'], ['knives', 'knife'], ['wives', 'wife'], ['leaves', 'leaf'],
        ['selves', 'self'], ['shelves', 'shelf'], ['halves', 'half'], ['wolves', 'wolf'],
        ['thieves', 'thief'], ['loaves', 'loaf']
    ]);

    async function loadDefaultCSV() {
        try {
            document.getElementById('file-status').innerHTML = '<span style="color: #6366f1;">‚è≥ Loading default Oxford 5000 + Cambridge C2 word list...</span>';
            const response = await fetch(DEFAULT_CSV_URL);
            if (!response.ok) throw new Error('Failed to fetch CSV');
            const text = await response.text();
            parseCSV(text);
            document.getElementById('file-text').innerHTML = `<strong>${DEFAULT_CSV_NAME}</strong> (pre-loaded)`;
            document.getElementById('file-hint').textContent = 'Click here to upload a different CSV file';
            document.getElementById('file-label').style.borderColor = 'var(--primary)';
            document.getElementById('file-label').style.backgroundColor = '#eef2ff';
        } catch (error) {
            console.error('Error loading default CSV:', error);
            document.getElementById('file-status').innerHTML = '<span style="color: #dc2626;">‚ö†Ô∏è Failed to load default file. Please upload a CSV manually.</span>';
        }
    }
    loadDefaultCSV();

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('file-text').innerHTML = `<strong>${file.name}</strong> selected`;
        document.getElementById('file-label').style.borderColor = 'var(--primary)';
        document.getElementById('file-label').style.backgroundColor = '#eef2ff';
        const reader = new FileReader();
        reader.onload = function(e) { parseCSV(e.target.result); };
        reader.readAsText(file);
    });

    function parseCSV(csvText) {
        dictionary.clear(); dictionaryWithPos.clear();
        const levelRank = { 'A1': 1, 'A2': 2, 'B1': 3, 'B2': 4, 'C1': 5, 'C2': 6 };
        const lines = csvText.split(/\r?\n/); let count = 0;
        lines.forEach(line => {
            if (!line.trim()) return;
            const parts = line.split(',');
            if (parts.length < 2) return;
            const level = parts[0].trim().toUpperCase();
            const word = parts[1].trim();
            const pos = parts.length > 2 ? parts[2].trim().toLowerCase() : '';
            const cleanWord = word.toLowerCase();
            if (!['A1', 'A2', 'B1', 'B2', 'C1', 'C2'].includes(level)) return;
            if (pos) {
                let normPos = pos.startsWith('v') ? 'v' : pos.startsWith('n') ? 'n' :
                              pos.startsWith('adj') ? 'adj' : pos.startsWith('adv') ? 'adv' : pos;
                dictionaryWithPos.set(`${cleanWord},${normPos}`, level);
            }
            if (!dictionary.has(cleanWord)) {
                dictionary.set(cleanWord, { level, pos });
            } else {
                const cur = dictionary.get(cleanWord);
                if ((levelRank[level] || 99) < (levelRank[cur.level] || 99))
                    dictionary.set(cleanWord, { level, pos });
            }
            count++;
        });
        isFileLoaded = true;
        document.getElementById('file-status').textContent = `‚úì Successfully loaded ${count} words from database.`;
    }

    function lookupWord(word) {
        const lower = word.toLowerCase();
        if (dictionary.has(lower)) return { found: true, level: dictionary.get(lower).level, source: 'dictionary' };
        if (SUPPLEMENTARY_WORDS.has(lower)) return { found: true, level: SUPPLEMENTARY_WORDS.get(lower), source: 'supplementary' };
        if (SPELLING_VARIANTS.has(lower)) {
            const am = SPELLING_VARIANTS.get(lower);
            if (dictionary.has(am)) return { found: true, level: dictionary.get(am).level, source: 'variant' };
            if (SUPPLEMENTARY_WORDS.has(am)) return { found: true, level: SUPPLEMENTARY_WORDS.get(am), source: 'variant' };
        }
        return { found: false, level: null, source: null };
    }

    function lemmatize(word) {
        const lower = word.toLowerCase().replace(/['']/g, "'");
        const d = lookupWord(lower);
        if (d.found) return { lemma: lower, found: true, level: d.level };
        if (IRREGULAR_VERBS.has(lower)) {
            const base = IRREGULAR_VERBS.get(lower);
            const b = lookupWord(base);
            if (b.found) return { lemma: base, found: true, level: b.level };
        }
        if (CONTRACTIONS.has(lower)) {
            const base = CONTRACTIONS.get(lower);
            const b = lookupWord(base);
            if (b.found) return { lemma: base, found: true, level: b.level, isContraction: true };
            return { lemma: lower, found: true, level: 'A1', isContraction: true };
        }
        const m = tryMorphologicalAnalysis(lower);
        if (m.found) return m;
        return { lemma: lower, found: false, level: null };
    }

    function tryMorphologicalAnalysis(word) {
        const tryLookup = (base) => {
            const r = lookupWord(base);
            return r.found ? { lemma: base, found: true, level: r.level } : null;
        };
        if (word.endsWith('ing') && word.length > 4) {
            let base = word.slice(0, -3);
            if (base.length >= 2 && base.slice(-2)[0] === base.slice(-2)[1] && /[bcdfgklmnprstvz]/.test(base.slice(-1))) { let r = tryLookup(base.slice(0, -1)); if (r) return r; }
            let r = tryLookup(base + 'e'); if (r) return r;
            r = tryLookup(base); if (r) return r;
            if (base.endsWith('y')) { r = tryLookup(base.slice(0, -1) + 'ie'); if (r) return r; }
        }
        if (word.endsWith('ed') && word.length > 3) {
            let base = word.slice(0, -2);
            if (base.length >= 2 && base.slice(-2)[0] === base.slice(-2)[1] && /[bcdfgklmnprstvz]/.test(base.slice(-1))) { let r = tryLookup(base.slice(0, -1)); if (r) return r; }
            let r = tryLookup(base + 'e'); if (r) return r;
            r = tryLookup(base); if (r) return r;
            if (word.endsWith('ied')) { r = tryLookup(word.slice(0, -3) + 'y'); if (r) return r; }
        }
        if (word.endsWith('s') && word.length > 2 && !word.endsWith('ss')) {
            if (word.endsWith('ies') && word.length > 4) { let r = tryLookup(word.slice(0, -3) + 'y'); if (r) return r; }
            let r = tryLookup(word.slice(0, -1)); if (r) return r;
            if (word.endsWith('es') && word.length > 3) { r = tryLookup(word.slice(0, -2)); if (r) return r; }
        }
        if (word.endsWith('er') && word.length > 3) {
            let base = word.slice(0, -2);
            if (base.length >= 2 && base.slice(-2)[0] === base.slice(-2)[1] && /[bcdfgklmnprstvz]/.test(base.slice(-1))) { let r = tryLookup(base.slice(0, -1)); if (r) return r; }
            let r = tryLookup(base + 'e'); if (r) return r;
            r = tryLookup(base); if (r) return r;
            if (word.endsWith('ier')) { r = tryLookup(word.slice(0, -3) + 'y'); if (r) return r; }
        }
        if (word.endsWith('est') && word.length > 4) {
            let base = word.slice(0, -3);
            if (base.length >= 2 && base.slice(-2)[0] === base.slice(-2)[1] && /[bcdfgklmnprstvz]/.test(base.slice(-1))) { let r = tryLookup(base.slice(0, -1)); if (r) return r; }
            let r = tryLookup(base + 'e'); if (r) return r;
            r = tryLookup(base); if (r) return r;
            if (word.endsWith('iest')) { r = tryLookup(word.slice(0, -4) + 'y'); if (r) return r; }
        }
        if (word.endsWith('ly') && word.length > 3) {
            let base = word.slice(0, -2);
            let r = tryLookup(base); if (r) return r;
            if (word.endsWith('ily')) { r = tryLookup(word.slice(0, -3) + 'y'); if (r) return r; }
            if (base.endsWith('l')) { r = tryLookup(base + 'e'); if (r) return r; }
            r = tryLookup(base + 'e'); if (r) return r;
        }
        if (word.endsWith('ness') && word.length > 5) {
            let r = tryLookup(word.slice(0, -4)); if (r) return r;
            if (word.endsWith('iness')) { r = tryLookup(word.slice(0, -5) + 'y'); if (r) return r; }
        }
        if (word.endsWith('ment') && word.length > 5) {
            let r = tryLookup(word.slice(0, -4)); if (r) return r;
            r = tryLookup(word.slice(0, -4) + 'e'); if (r) return r;
        }
        if ((word.endsWith('tion') || word.endsWith('sion')) && word.length > 5) {
            let base = word.slice(0, -4);
            let r = tryLookup(base); if (r) return r;
            r = tryLookup(base + 'e'); if (r) return r;
            if (word.endsWith('ation') && word.length > 6) {
                r = tryLookup(word.slice(0, -5) + 'e'); if (r) return r;
                r = tryLookup(word.slice(0, -5)); if (r) return r;
            }
        }
        if ((word.endsWith('able') || word.endsWith('ible')) && word.length > 5) {
            let r = tryLookup(word.slice(0, -4)); if (r) return r;
            r = tryLookup(word.slice(0, -4) + 'e'); if (r) return r;
        }
        if (word.endsWith('ful') && word.length > 4) {
            let r = tryLookup(word.slice(0, -3)); if (r) return r;
            r = tryLookup(word.slice(0, -3) + 'y'); if (r) return r;
        }
        if (word.endsWith('less') && word.length > 5) { let r = tryLookup(word.slice(0, -4)); if (r) return r; }
        if (word.endsWith('ous') && word.length > 4) {
            let r = tryLookup(word.slice(0, -3) + 'e'); if (r) return r;
            r = tryLookup(word.slice(0, -3)); if (r) return r;
        }
        if (word.endsWith('ive') && word.length > 4) {
            let r = tryLookup(word.slice(0, -3) + 'e'); if (r) return r;
            r = tryLookup(word.slice(0, -3)); if (r) return r;
        }
        if (word.endsWith('ic') && word.length > 3) {
            let r = tryLookup(word.slice(0, -2)); if (r) return r;
            if (word.endsWith('istic')) { r = tryLookup(word.slice(0, -5)); if (r) return r; }
        }
        if (word.endsWith('al') && word.length > 3) {
            let r = tryLookup(word.slice(0, -2)); if (r) return r;
            r = tryLookup(word.slice(0, -2) + 'e'); if (r) return r;
        }
        return { lemma: word, found: false, level: null };
    }

    function classifyOffListWord(word, originalWord, isAtSentenceStart) {
        const lower = word.toLowerCase(); const len = lower.length;
        const result = { type: 'unknown', difficultyWeight: 0, reason: '', isLiterary: false, estimatedLevel: null };
        if (lower.includes('@') || lower.includes('.com') || lower.includes('.org') || lower.includes('.edu') || lower.includes('.hk') || lower.includes('www') || /^[a-z]+\.[a-z]+$/i.test(lower)) { result.type = 'email_url'; return result; }
        if (/^\d+$/.test(word) || /^\d+[\.,]\d+$/.test(word) || /^\d+(st|nd|rd|th)$/i.test(word)) { result.type = 'number'; return result; }
        if (len <= 2) { result.type = 'abbreviation'; return result; }
        if (PROPER_NOUNS.has(lower)) { result.type = 'proper_noun'; return result; }
        if (/^[A-Z][a-z]+$/.test(originalWord) && !isAtSentenceStart) { result.type = 'proper_noun'; return result; }
        if (/^[A-Z]{2,}$/.test(originalWord)) { result.type = 'acronym'; return result; }
        if (/^(mr|mrs|ms|dr|prof|st|mt)$/i.test(lower)) { result.type = 'abbreviation'; return result; }
        if (LITERARY_VOCABULARY.has(lower)) { result.type = 'literary'; result.difficultyWeight = 2.0; result.reason = 'literary/evocative vocabulary'; result.isLiterary = true; result.estimatedLevel = 'C1'; return result; }
        if (word.includes('-')) {
            const parts = word.split('-').filter(p => p.length > 0);
            let knownCount = 0; let maxLevel = 'A1';
            const lr = { 'A1': 1, 'A2': 2, 'B1': 3, 'B2': 4, 'C1': 5, 'C2': 6 };
            for (const part of parts) { const l = lookupWord(part.toLowerCase()); if (l.found) { knownCount++; if (lr[l.level] > lr[maxLevel]) maxLevel = l.level; } }
            if (knownCount === parts.length) { result.type = 'compound'; result.difficultyWeight = 0.3; result.estimatedLevel = maxLevel; return result; }
            else if (knownCount > 0) { result.type = 'compound_partial'; result.difficultyWeight = 0.5; return result; }
        }
        if (len <= 5) { result.type = 'simple_unknown'; result.difficultyWeight = 0.2; result.estimatedLevel = 'A2'; return result; }
        if (len <= 7) { result.type = 'moderate_unknown'; result.difficultyWeight = 0.4; result.estimatedLevel = 'B1'; return result; }
        for (const suffix of ['ization', 'isation', 'ification', 'ology', 'ological', 'istically']) { if (lower.endsWith(suffix)) { result.type = 'advanced'; result.difficultyWeight = 1.5; result.estimatedLevel = 'C1'; return result; } }
        for (const suffix of ['ment', 'tion', 'sion', 'ance', 'ence', 'ity', 'ness', 'ious', 'eous']) { if (lower.endsWith(suffix) && len > suffix.length + 3) { result.type = 'moderate_advanced'; result.difficultyWeight = 0.7; result.estimatedLevel = 'B2'; return result; } }
        if (len >= 12) { result.difficultyWeight = 1.2; result.estimatedLevel = 'C1'; }
        else if (len >= 10) { result.difficultyWeight = 0.9; result.estimatedLevel = 'B2'; }
        else if (len >= 8) { result.difficultyWeight = 0.6; result.estimatedLevel = 'B1'; }
        else { result.difficultyWeight = 0.3; result.estimatedLevel = 'B1'; }
        return result;
    }

    function analyzeTextStyle(text) {
        const style = { idiomCount: 0, idiomWeight: 0, idiomDetails: [], figurativeCount: 0, figurativeWeight: 0, syntaxComplexity: 0, dialoguePresent: false, narrativeMarkers: 0, isLiterary: false, isAcademic: false, isSimple: false };
        for (const idiom of IDIOM_PATTERNS) { const m = text.match(idiom.pattern); if (m) { style.idiomCount += m.length; style.idiomWeight += idiom.weight * m.length; style.idiomDetails.push({ pattern: idiom.pattern.source, level: idiom.level, count: m.length }); } }
        for (const fig of FIGURATIVE_PATTERNS) { const m = text.match(fig.pattern); if (m) { style.figurativeCount += m.length; style.figurativeWeight += fig.weight * m.length; } }
        for (const syntax of COMPLEX_SYNTAX_PATTERNS) { const m = text.match(syntax.pattern); if (m) { style.syntaxComplexity += syntax.weight * m.length; } }
        style.dialoguePresent = (text.match(/"[^"]+"/g) || []).length > 2 || (text.match(/'[^']+'/g) || []).length > 2;
        for (const p of [/\bI (remember|recall|think back|grew up|was|had|felt|knew|saw|heard)\b/gi, /\bmy (mother|father|mom|dad|parents|brother|sister|family)\b/gi, /\blooking back\b/gi, /\bas a (child|kid|girl|boy)\b/gi, /\bgrowing up\b/gi]) { const m = text.match(p); if (m) style.narrativeMarkers += m.length; }
        let ac = 0; for (const p of [/\baccording to\b/gi, /\bthe (fact|reality|truth) (is|was) that\b/gi, /\bin (fact|addition|conclusion|contrast)\b/gi, /\bfor (example|instance)\b/gi, /\bthis (means|suggests|indicates|shows)\b/gi, /\bas a result\b/gi, /\bhowever,\b/gi, /\btherefore,?\b/gi]) { const m = text.match(p); if (m) ac += m.length; }
        let sc = 0; for (const p of [/\byou can\b/gi, /\bplease\b/gi, /\bcontact\b/gi, /\bquestions?\b/gi, /\bcome and\b/gi, /\bnow is the time\b/gi, /\blet us know\b/gi]) { const m = text.match(p); if (m) sc += m.length; }
        const wc = text.split(/\s+/).length;
        style.isLiterary = ((style.idiomCount/wc)*1000 > 3 || (style.figurativeCount/wc)*1000 > 2 || (style.narrativeMarkers/wc)*1000 > 5 || (style.dialoguePresent && (style.narrativeMarkers/wc)*1000 > 2) || style.syntaxComplexity > 5);
        style.isAcademic = (ac/wc)*1000 > 5 && !style.isLiterary;
        style.isSimple = (sc/wc)*1000 > 20 && !style.isLiterary && !style.isAcademic;
        return style;
    }

    function showAlert(message) {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
        modal.innerHTML = `<div style="background:white;padding:24px;border-radius:12px;max-width:320px;width:90%;text-align:center;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);"><p style="margin:0 0 20px;color:#374151;font-size:1rem;">${message}</p><button style="background:var(--primary);color:white;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:600;" onclick="this.closest('div').parentElement.remove()">OK</button></div>`;
        document.body.appendChild(modal);
    }

    function treemapLayout(data, rect) {
        const items = data.filter(d => d.value > 0);
        if (items.length === 0) return [];
        const totalValue = items.reduce((sum, d) => sum + d.value, 0);
        const containerArea = rect.w * rect.h;
        const normalized = items.map(d => ({
            ...d, area: (d.value / totalValue) * containerArea
        })).sort((a, b) => b.area - a.area);
        const result = [];
        squarifyHelper(normalized, { ...rect }, result);
        return result;
    }

    function squarifyHelper(items, rect, result) {
        if (items.length === 0 || rect.w <= 0 || rect.h <= 0) return;
        if (items.length === 1) {
            result.push({ ...items[0], x: rect.x, y: rect.y, w: rect.w, h: rect.h });
            return;
        }
        const shortSide = Math.min(rect.w, rect.h);
        let row = [items[0]]; let bestWorst = worstAR(row, shortSide);
        for (let i = 1; i < items.length; i++) {
            const testRow = [...row, items[i]];
            const testWorst = worstAR(testRow, shortSide);
            if (testWorst <= bestWorst) { row = testRow; bestWorst = testWorst; } else break;
        }
        const remaining = items.slice(row.length);
        const rowArea = row.reduce((s, d) => s + d.area, 0);
        if (rect.w >= rect.h) {
            const rowWidth = rowArea / rect.h; let y = rect.y;
            for (const item of row) { const h = item.area / rowWidth; result.push({ ...item, x: rect.x, y, w: rowWidth, h }); y += h; }
            squarifyHelper(remaining, { x: rect.x + rowWidth, y: rect.y, w: rect.w - rowWidth, h: rect.h }, result);
        } else {
            const rowHeight = rowArea / rect.w; let x = rect.x;
            for (const item of row) { const w = item.area / rowHeight; result.push({ ...item, x, y: rect.y, w, h: rowHeight }); x += w; }
            squarifyHelper(remaining, { x: rect.x, y: rect.y + rowHeight, w: rect.w, h: rect.h - rowHeight }, result);
        }
    }

    function worstAR(row, sideLength) {
        const total = row.reduce((s, d) => s + d.area, 0); let worst = 0;
        for (const item of row) { const r = (sideLength * sideLength * item.area) / (total * total); worst = Math.max(worst, Math.max(r, 1 / r)); }
        return worst;
    }

    let lastTreemapCounts = null;

    function renderTreemap(counts) {
        const container = document.getElementById('treemap-container');
        container.innerHTML = '';
        const total = counts.Total || 1;
        const calcPct = v => ((v / total) * 100).toFixed(1);

        const cefrItems = [
            { label: 'A1', value: counts.A1, bg: '#d1fae5', text: '#065f46' },
            { label: 'A2', value: counts.A2, bg: '#a7f3d0', text: '#064e3b' },
            { label: 'B1', value: counts.B1, bg: '#fef3c7', text: '#92400e' },
            { label: 'B2', value: counts.B2, bg: '#fde68a', text: '#78350f' },
            { label: 'C1', value: counts.C1, bg: '#fca5a5', text: '#7f1d1d' },
            { label: 'C2', value: counts.C2, bg: '#d8b4fe', text: '#3b0764' }
        ];
        const offItem = { label: 'Off List', value: counts.Off, bg: '#e5e7eb', text: '#6b7280' };

        const cW = container.offsetWidth;
        const cH = container.offsetHeight;
        if (cW === 0 || cH === 0) return;

        const cefrTotal = cefrItems.reduce((s, d) => s + d.value, 0);
        const grandTotal = cefrTotal + offItem.value;
        if (grandTotal === 0) return;

        let allCells = [];

        if (cefrTotal > 0 && offItem.value > 0) {
            const cefrWidth = Math.round((cefrTotal / grandTotal) * cW);
            const offWidth = cW - cefrWidth;
            allCells = treemapLayout(cefrItems, { x: 0, y: 0, w: cefrWidth, h: cH });
            allCells.push({ ...offItem, x: cefrWidth, y: 0, w: offWidth, h: cH });
        } else if (cefrTotal > 0) {
            allCells = treemapLayout(cefrItems, { x: 0, y: 0, w: cW, h: cH });
        } else {
            allCells.push({ ...offItem, x: 0, y: 0, w: cW, h: cH });
        }

        const tooltip = document.getElementById('treemap-tooltip');

        allCells.forEach((cell, idx) => {
            if (!cell.value || cell.value <= 0) return;
            const pct = calcPct(cell.value);
            const div = document.createElement('div');
            div.className = 'treemap-cell';
            div.style.left   = cell.x + 'px';
            div.style.top    = cell.y + 'px';
            div.style.width  = cell.w + 'px';
            div.style.height = cell.h + 'px';
            div.style.backgroundColor = cell.bg;
            div.style.color  = cell.text;
            div.style.animationDelay = (idx * 55) + 'ms';

            const minDim = Math.min(cell.w, cell.h);
            const area   = cell.w * cell.h;
            let sizeClass = 'size-lg';
            if      (minDim < 22 || area < 700)   sizeClass = 'size-dot';
            else if (minDim < 32 || area < 1500)   sizeClass = 'size-xxs';
            else if (minDim < 46 || area < 3200)   sizeClass = 'size-xs';
            else if (minDim < 62 || area < 5500)   sizeClass = 'size-sm';
            else if (minDim < 90 || area < 12000)  sizeClass = 'size-md';
            div.classList.add(sizeClass);

            div.innerHTML = `
                <span class="treemap-cell-level">${cell.label}</span>
                <span class="treemap-cell-count">${cell.value}</span>
                <span class="treemap-cell-percent">${pct}%</span>
            `;

            div.addEventListener('mouseenter', () => {
                tooltip.textContent = `${cell.label}: ${cell.value} words (${pct}%)`;
                tooltip.classList.add('visible');
            });
            div.addEventListener('mousemove', e => {
                tooltip.style.left = (e.clientX + 14) + 'px';
                tooltip.style.top  = (e.clientY - 36) + 'px';
            });
            div.addEventListener('mouseleave', () => tooltip.classList.remove('visible'));

            container.appendChild(div);
        });
    }

    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => { if (lastTreemapCounts) renderTreemap(lastTreemapCounts); }, 200);
    });

    let analysisData = {};

    function analyzePassage() {
        if (!isFileLoaded) { showAlert("Please upload the CSV file first."); return; }
        const text = document.getElementById('inputText').value;
        if (!text.trim()) { showAlert("Please enter some text to analyze."); return; }

        const outputDiv = document.getElementById('highlighted-content');
        outputDiv.innerHTML = '';
        const counts = { A1: 0, A2: 0, B1: 0, B2: 0, C1: 0, C2: 0, Off: 0, Total: 0 };
        const levelWeights = { A1: 1, A2: 2, B1: 3, B2: 4, C1: 5, C2: 6 };
        let weightedSum = 0, totalWordLength = 0, longWords = 0;
        const uniqueWords = new Set(), uniqueLemmas = new Set();
        const offListAnalysis = [], advancedWordsFound = [];
        let literaryOffListCount = 0;
        const wordsByLevel = { B1: new Map(), B2: new Map(), C1: new Map(), C2: new Map() };
        const textStyle = analyzeTextStyle(text);
        const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
        const sentenceCount = Math.max(sentences.length, 1);
        let complexSentences = 0;
        sentences.forEach(sent => {
            const words = sent.split(/\s+/).filter(w => w.length > 0);
            let ci = 0;
            if (words.length > 20) ci += 2; else if (words.length > 14) ci += 1;
            if (/\b(because|although|while|when|if|unless|since|whereas|despite|whether|even though|in order to|so that)\b/i.test(sent)) ci += 1;
            if (/\b(who|which|whom|whose)\b/i.test(sent)) ci += 1;
            if (sent.includes('‚Äì') || sent.includes('‚Äî')) ci += 1;
            if (/(?:^|[,;])\s*\w+ing\b/i.test(sent.trim())) ci += 1;
            if (/\b(was|were|been|being|is|are)\s+\w+ed\b/i.test(sent)) ci += 0.5;
            if ((sent.match(/\b(and|but|or|yet|so|because|although|while|when|if|unless|since|whereas|whether)\b/gi) || []).length >= 3) ci += 1;
            if (ci >= 2) complexSentences++;
        });

        let isAfterSentenceEnd = true;
        text.split(/([a-zA-Z0-9''-]+)/).forEach(token => {
            if (!/[a-zA-Z0-9]/.test(token)) { outputDiv.appendChild(document.createTextNode(token)); if (/[.!?]/.test(token)) isAfterSentenceEnd = true; return; }
            if (token.includes('@') || /\.(com|org|edu|hk|uk|net)$/i.test(token) || token === 'www' || /^[a-z]\.[a-z]+$/i.test(token)) { outputDiv.appendChild(document.createTextNode(token)); return; }
            counts.Total++;
            const cleanToken = token.toLowerCase().replace(/['''-]/g, '');
            totalWordLength += cleanToken.length; uniqueWords.add(cleanToken);
            if (cleanToken.length >= 8) longWords++;
            const lemmaResult = lemmatize(token); uniqueLemmas.add(lemmaResult.lemma);
            const span = document.createElement('span'); span.textContent = token; span.classList.add('cefr-word');
            if (lemmaResult.found && lemmaResult.level) {
                const level = lemmaResult.level.substring(0, 2).toUpperCase();
                if (['A1','A2','B1','B2','C1','C2'].includes(level)) {
                    span.classList.add(`level-${level}`); span.setAttribute('data-info', `${lemmaResult.lemma} (${level})`);
                    counts[level]++; weightedSum += levelWeights[level];
                    if (['B1','B2','C1','C2'].includes(level)) { const lk = lemmaResult.lemma.toLowerCase(); if (!wordsByLevel[level].has(lk)) { const pi = dictionary.get(lk); wordsByLevel[level].set(lk, { word: lemmaResult.lemma, pos: pi ? pi.pos : '' }); } }
                    if (['B2','C1','C2'].includes(level)) advancedWordsFound.push({ word: token, lemma: lemmaResult.lemma, level });
                } else { span.classList.add('level-XX'); counts.Off++; const c = classifyOffListWord(cleanToken, token, isAfterSentenceEnd); c.word = token; c.lemma = lemmaResult.lemma; offListAnalysis.push(c); if (c.isLiterary) literaryOffListCount++; }
            } else { span.classList.add('level-XX'); counts.Off++; const c = classifyOffListWord(cleanToken, token, isAfterSentenceEnd); c.word = token; c.lemma = lemmaResult.lemma; offListAnalysis.push(c); if (c.isLiterary) literaryOffListCount++; }
            outputDiv.appendChild(span); isAfterSentenceEnd = false;
        });

        let offListDifficultySum = 0, neutralOffList = 0, advancedOffList = 0;
        offListAnalysis.forEach(item => { offListDifficultySum += item.difficultyWeight; if (item.difficultyWeight <= 0.3) neutralOffList++; else if (item.difficultyWeight >= 1.0) advancedOffList++; });

        analysisData = { counts, weightedSum, offListDifficultySum, offListAnalysis, neutralOffList, advancedOffList, advancedWordsFound, literaryOffListCount, textStyle, wordsByLevel,
            metrics: { totalWords: counts.Total, uniqueWords: uniqueWords.size, uniqueLemmas: uniqueLemmas.size, avgWordLength: totalWordLength / Math.max(counts.Total, 1), longWordRatio: longWords / Math.max(counts.Total, 1), sentenceCount, avgSentenceLength: counts.Total / sentenceCount, lexicalDiversity: uniqueWords.size / Math.max(counts.Total, 1), complexSentenceRatio: complexSentences / sentenceCount }
        };

        document.getElementById('output-area').style.display = 'block';
        void document.getElementById('treemap-container').offsetWidth;
        updateStats(counts);
        determineVerdict();
        buildWordLists(wordsByLevel);
        document.getElementById('output-area').scrollIntoView({behavior: 'smooth'});
    }

    function updateStats(counts) {
        document.getElementById('count-total').textContent = counts.Total;
        lastTreemapCounts = counts;
        renderTreemap(counts);
    }

    function determineVerdict() {
        const { counts, weightedSum, offListDifficultySum, metrics, neutralOffList, advancedOffList, advancedWordsFound, offListAnalysis, textStyle, literaryOffListCount, wordsByLevel } = analysisData;
        if (counts.Total === 0) return;
        const total = counts.Total, onListWords = total - counts.Off;
        const pA1 = (counts.A1/total)*100, pA2 = (counts.A2/total)*100, pB1 = (counts.B1/total)*100, pB2 = (counts.B2/total)*100, pC1 = (counts.C1/total)*100, pC2 = (counts.C2/total)*100;
        const pBasic = pA1+pA2, pAdvanced = pC1+pC2, pB2Plus = pB2+pC1+pC2, pB1Plus = pB1+pB2+pC1+pC2;
        const avgDifficulty = onListWords > 0 ? weightedSum / onListWords : 1;
        const uniqueB2 = wordsByLevel.B2 ? wordsByLevel.B2.size : 0, uniqueC1 = wordsByLevel.C1 ? wordsByLevel.C1.size : 0, uniqueC2 = wordsByLevel.C2 ? wordsByLevel.C2.size : 0, uniqueAdvanced = uniqueC1 + uniqueC2;
        const difficultOffList = offListAnalysis.filter(i => i.difficultyWeight >= 1.0);
        const effectiveAdvancedPct = pAdvanced + (literaryOffListCount/total)*100 + (difficultOffList.length/total)*100*0.5;
        let cumulative = 0, p95Level = 'C2'; const threshold95 = onListWords * 0.95;
        for (const lev of ['A1','A2','B1','B2','C1','C2']) { cumulative += counts[lev]; if (cumulative >= threshold95 && p95Level === 'C2') p95Level = lev; }
        const avgSentLen = metrics.avgSentenceLength, complexSentRatio = metrics.complexSentenceRatio, avgWordLen = metrics.avgWordLength;
        let sentComplexity = 0;
        if (avgSentLen >= 25) sentComplexity += 2.5; else if (avgSentLen >= 20) sentComplexity += 2.0; else if (avgSentLen >= 16) sentComplexity += 1.5; else if (avgSentLen >= 12) sentComplexity += 1.0; else if (avgSentLen >= 8) sentComplexity += 0.5;
        sentComplexity += Math.min(complexSentRatio * 2.5, 2.0); sentComplexity += Math.min(textStyle.syntaxComplexity * 0.3, 1.0);
        let styleComplexity = 0;
        styleComplexity += Math.min(textStyle.idiomWeight * 0.4, 2.0); styleComplexity += Math.min(textStyle.figurativeWeight * 0.3, 1.5); styleComplexity += Math.min(literaryOffListCount * 0.4, 1.5);
        if (avgWordLen >= 5.5) styleComplexity += 0.5; if (metrics.lexicalDiversity >= 0.65) styleComplexity += 0.5;
        const textTypeIndicator = textStyle.isLiterary ? 'üìö Literary' : textStyle.isAcademic ? 'üì∞ Academic' : textStyle.isSimple ? 'üìã Simple/Notice' : 'üìù General';
        let level, confidence; const factors = [];

        const c2 = (pC2>=3||(pC2>=1.5&&pAdvanced>=5)||(pC2>=1&&effectiveAdvancedPct>=5&&(sentComplexity>=3||styleComplexity>=3))||(effectiveAdvancedPct>=7&&sentComplexity>=3.5&&styleComplexity>=2.5)||(pAdvanced>=5&&uniqueAdvanced>=10&&sentComplexity>=3));

        const c1 = (
            pAdvanced >= 4 ||
            effectiveAdvancedPct >= 5 ||
            (pAdvanced >= 2.5 && sentComplexity >= 3 && styleComplexity >= 1) ||
            (pAdvanced >= 2 && sentComplexity >= 3 && styleComplexity >= 2) ||
            (pAdvanced >= 2 && sentComplexity >= 4) ||
            (pAdvanced >= 3 && uniqueAdvanced >= 5 && sentComplexity >= 2) ||
            (effectiveAdvancedPct >= 4 && sentComplexity >= 3 && styleComplexity >= 2) ||
            (uniqueAdvanced >= 8 && pAdvanced >= 3) ||
            (pAdvanced >= 2 && styleComplexity >= 3)
        );

        const b2 = (pB2>=5||(pB2>=3&&pAdvanced>=0.5&&sentComplexity>=1.5)||(pB2>=3&&uniqueB2>=5)||pB2Plus>=6||(p95Level==='B2'&&pB2>=3)||(avgDifficulty>=2.5&&pB1Plus>=15));

        // ‚òÖ CHANGED: tightened B1 trigger ‚Äî raised pB1Plus threshold (8‚Üí10) and
        //   lowered pBasic threshold (82‚Üí75) so off-list proper nouns don't falsely
        //   inflate the level for simple texts
        const b1 = (pB1>=5||pB1Plus>=10||(pB1>=3&&pB2>=1)||avgDifficulty>=2.0||(p95Level==='B1'&&pB1>=3)||pBasic<75);

        const a2 = (pBasic<90||pB1>=2||avgSentLen>=8);

        if (c2) { level='C2'; confidence=(pC2>=3||(pAdvanced>=5&&sentComplexity>=3))?'high':'medium'; if(pC2>=1)factors.push(`${pC2.toFixed(1)}% C2 vocabulary`); if(pAdvanced>=2)factors.push(`${pAdvanced.toFixed(1)}% C1+C2 vocabulary`); if(sentComplexity>=3)factors.push('highly complex sentence structure'); if(styleComplexity>=2.5)factors.push('sophisticated stylistic features'); }
        else if (c1) { level='C1'; confidence=(pAdvanced>=4||(effectiveAdvancedPct>=4&&sentComplexity>=3))?'high':'medium'; factors.push(`${pAdvanced.toFixed(1)}% C1+C2 vocabulary`); if(uniqueAdvanced>=3)factors.push(`${uniqueAdvanced} unique C1/C2 word types`); if(sentComplexity>=2.5)factors.push('complex sentence structure'); if(styleComplexity>=2)factors.push('advanced stylistic features'); }
        else if (b2) { level='B2'; confidence=(pB2>=5||pB2Plus>=7)?'high':'medium'; factors.push(`${pB2.toFixed(1)}% B2 vocabulary`); if(pAdvanced>=0.5)factors.push(`${pAdvanced.toFixed(1)}% C1+C2 vocabulary`); if(sentComplexity>=1.5)factors.push('moderate sentence complexity'); }
        else if (b1) { level='B1'; confidence=pB1>=8?'high':'medium'; factors.push(`${pB1.toFixed(1)}% B1 vocabulary`); if(pB2>=1)factors.push('some B2 vocabulary present'); }
        else if (a2) { level='A2'; confidence='high'; factors.push(`${pBasic.toFixed(1)}% basic (A1+A2) vocabulary`); }
        else { level='A1'; confidence='high'; factors.push(`${pBasic.toFixed(1)}% basic (A1+A2) vocabulary`); }

        // Existing guard: no C1/C2 words in list at all
        if(counts.C1===0&&counts.C2===0&&literaryOffListCount<2&&difficultOffList.length<4&&sentComplexity<3.5&&styleComplexity<2.5&&(level==='C1'||level==='C2')){level='B2';confidence='medium';factors.push('no C1/C2 vocabulary detected in word list');}

        // Strengthened guard ‚Äî downgrade C1 when style/syntax evidence is weak
        if (level === 'C1' && styleComplexity < 1.5 && sentComplexity < 3.5) {
            if (pAdvanced < 3.5 && uniqueAdvanced < 6) {
                level = 'B2'; confidence = 'medium';
                factors.push('insufficient combined evidence for C1: low style/syntax complexity relative to vocabulary');
            }
        }

        if(pB2Plus<2&&effectiveAdvancedPct<2&&uniqueB2+uniqueAdvanced<3&&(level==='B2'||level==='C1'||level==='C2')){level='B1';confidence='medium';factors.push('minimal upper-level vocabulary');}
        if(pBasic>=88&&pB2Plus<3&&sentComplexity<1.5&&(level==='B2'||level==='C1'||level==='C2')){level=pB1>=5?'B1':'A2';confidence='medium';factors.push('vocabulary is overwhelmingly basic');}
        if(level==='C1'&&uniqueAdvanced<2&&literaryOffListCount<2&&difficultOffList.length<3){level='B2';confidence='medium';factors.push('insufficient unique advanced vocabulary for C1');}
        if(level==='C2'&&uniqueC2<2&&!(sentComplexity>=4&&styleComplexity>=3&&effectiveAdvancedPct>=5)){level='C1';confidence='medium';factors.push('insufficient evidence for C2, downgraded to C1');}
        if(textStyle.isSimple&&sentComplexity<2&&(level==='B2'||level==='C1')){const lo=['A1','A2','B1','B2','C1','C2'];level=lo[Math.max(lo.indexOf(level)-1,0)];factors.push('simple text structure');if(confidence==='high')confidence='medium';}

        // ‚òÖ NEW: Guard ‚Äî downgrade B1 to A2 for simple texts with marginal B1 evidence.
        //   A text should only be rated B1 if it has EITHER strong B1 vocabulary
        //   (‚â•10% B1 or ‚â•12 unique B1 types) OR moderate B1 vocabulary (‚â•6%) combined
        //   with notable sentence complexity (‚â•2.0) or avg difficulty (‚â•1.8).
        //   If neither condition holds and the on-list vocabulary is predominantly
        //   basic, the text is more accurately classified as A2.
        if (level === 'B1' && pB2Plus < 2.5) {
            const onListBasicPct = onListWords > 0 ? ((counts.A1 + counts.A2) / onListWords) * 100 : 100;
            const uniqueB1Count = wordsByLevel.B1 ? wordsByLevel.B1.size : 0;
            const strongB1Vocab = pB1 >= 10 || uniqueB1Count >= 12;
            const moderateB1WithComplexity = pB1 >= 6 && (sentComplexity >= 2.0 || avgDifficulty >= 1.8);
            if (!strongB1Vocab && !moderateB1WithComplexity && onListBasicPct >= 80) {
                level = 'A2'; confidence = 'medium';
                factors.length = 0;
                factors.push(`${pBasic.toFixed(1)}% basic (A1+A2) vocabulary`);
                factors.push('some B1 vocabulary present but insufficient combined complexity for B1');
            }
        }

        if(total<50){if(confidence==='high')confidence='medium';else confidence='low';}
        if(total<30)confidence='low';

        const ld={'C2':'This text requires <strong>mastery-level (C2) proficiency</strong>.','C1':'This text requires <strong>advanced (C1) proficiency</strong>.','B2':'This text is suitable for <strong>upper-intermediate (B2)</strong> learners.','B1':'This text is suitable for <strong>intermediate (B1)</strong> learners.','A2':'This text is suitable for <strong>elementary (A2)</strong> learners.','A1':'This text is suitable for <strong>beginners (A1)</strong>.'};
        let explanation = ld[level]; if(factors.length>0) explanation += ` Key indicators: ${[...new Set(factors)].join('; ')}.`;
        const cl={'high':'üü¢ High confidence','medium':'üü° Medium confidence','low':'üü† Low confidence'};
        const nl={'A1':'A2','A2':'B1','B1':'B2','B2':'C1','C1':'C2'}[level]||null;
        const rec = level==='C2'?`This passage is appropriate for <strong>C2</strong> learners and represents the highest level of language proficiency.`:`This passage is appropriate for <strong>${level}</strong> learners for intensive study, or for <strong>${nl}</strong> learners for extensive reading practice.`;
        document.getElementById('verdict-text').innerHTML = `
            <strong style="font-size:1.4em;color:#1e3a8a;">Text Level: ${level}</strong>
            <span style="margin-left:15px;font-size:0.85em;color:#6b7280;">${cl[confidence]}</span>
            <br><br>${explanation}
            <br><br><em style="color:#6b7280;">Text Type:</em> <span style="color:#374151;font-weight:600;">${textTypeIndicator}</span>
            <br><em style="color:#6b7280;">Text Metrics:</em> <span style="color:#374151;">${total} words across ${metrics.sentenceCount} sentences (avg ${avgSentLen.toFixed(1)} words/sentence) ‚Ä¢ Avg word length: ${avgWordLen.toFixed(1)} chars</span>
            <br><em style="color:#6b7280;">Vocabulary:</em> <span style="color:#374151;">Basic (A1+A2): ${pBasic.toFixed(1)}% ‚Ä¢ Intermediate (B1): ${pB1.toFixed(1)}% ‚Ä¢ Upper-Int (B2): ${pB2.toFixed(1)}% ‚Ä¢ Advanced (C1+C2): ${pAdvanced.toFixed(1)}% ‚Ä¢ Weighted avg: ${avgDifficulty.toFixed(2)}/6</span>
            <br><em style="color:#6b7280;">Analysis Detail:</em> <span style="color:#374151;">Eff. advanced: ${effectiveAdvancedPct.toFixed(1)}% ‚Ä¢ Unique C1/C2 types: ${uniqueAdvanced} ‚Ä¢ Syntax score: ${sentComplexity.toFixed(1)}/5 ‚Ä¢ Style score: ${styleComplexity.toFixed(1)}/5 ‚Ä¢ 95th pctile: ${p95Level}</span>
            ${total<50?`<br><br><em style="color:#d97706;">‚ö†Ô∏è Short text (${total} words) ‚Äî results may be less reliable.</em>`:''}
            <br><br><em style="color:#6b7280;">Recommendation:</em> <span style="color:#374151;">${rec}</span>
        `;
    }

    function formatPos(pos) {
        if (!pos) return '';
        const p = pos.toLowerCase().trim();
        return {'v':'v','verb':'v','n':'n','noun':'n','adj':'adj','adjective':'adj','adv':'adv','adverb':'adv','prep':'prep','preposition':'prep','conj':'conj','conjunction':'conj','det':'det','determiner':'det','pron':'pron','pronoun':'pron','excl':'excl','exclamation':'excl','number':'num','num':'num'}[p] || p;
    }

    function buildWordLists(wordsByLevel) {
        const container = document.getElementById('word-lists-content');
        const wrapper = document.getElementById('word-lists-area');
        container.innerHTML = '';
        const dotColors = { B1: '#fcd34d', B2: '#f59e0b', C1: '#ef4444', C2: '#a855f7' };
        let hasAny = false;
        for (const level of ['B1','B2','C1','C2']) {
            const wm = wordsByLevel[level]; if (!wm || wm.size === 0) continue; hasAny = true;
            const sorted = Array.from(wm.values()).sort((a,b) => a.word.toLowerCase().localeCompare(b.word.toLowerCase()));
            const block = document.createElement('div'); block.className = 'word-level-block';
            const header = document.createElement('div'); header.className = `word-level-header word-level-header-${level}`;
            header.innerHTML = `<span class="level-badge"><span class="badge-dot" style="background:${dotColors[level]}"></span>${level} Words</span><span style="display:flex;align-items:center;gap:10px;"><span class="word-count-tag">${sorted.length} word${sorted.length!==1?'s':''}</span><button class="copy-btn" onclick="copyWordList(this, '${level}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>Copy</button></span>`;
            const body = document.createElement('div'); body.className = 'word-level-body'; body.setAttribute('data-level', level);
            for (const entry of sorted) {
                const chip = document.createElement('span'); chip.className = 'word-chip';
                const posStr = formatPos(entry.pos);
                chip.innerHTML = posStr ? `${entry.word} <span class="pos-tag">(${posStr})</span>` : entry.word;
                chip.setAttribute('data-word', entry.word.toLowerCase());
                chip.addEventListener('click', function() { jumpToWordInText(this.getAttribute('data-word')); });
                body.appendChild(chip);
            }
            block.appendChild(header); block.appendChild(body); container.appendChild(block);
        }
        wrapper.style.display = hasAny ? 'block' : 'none';
    }

    function jumpToWordInText(word) {
        const container = document.getElementById('highlighted-content');
        const spans = container.querySelectorAll('.cefr-word'); let target = null;
        for (const span of spans) { const l = lemmatize(span.textContent); if (l.lemma === word || span.textContent.toLowerCase() === word) { target = span; break; } }
        if (!target) return;
        const prev = container.querySelector('.jump-highlight'); if (prev) prev.classList.remove('jump-highlight');
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => target.classList.add('jump-highlight'), 300);
        setTimeout(() => target.classList.remove('jump-highlight'), 2000);
    }

    function copyWordList(btn, level) {
        const body = document.querySelector(`.word-level-body[data-level="${level}"]`);
        if (!body) return;
        const lines = []; body.querySelectorAll('.word-chip').forEach(chip => lines.push(chip.textContent.trim()));
        navigator.clipboard.writeText(lines.join('\n')).then(() => {
            btn.classList.add('copied'); const orig = btn.innerHTML;
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Copied!`;
            setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = orig; }, 2000);
        });
    }

    function clearAll() {
        document.getElementById('inputText').value = '';
        document.getElementById('output-area').style.display = 'none';
        document.getElementById('highlighted-content').innerHTML = '';
        document.getElementById('treemap-container').innerHTML = '';
        document.getElementById('word-lists-area').style.display = 'none';
        document.getElementById('word-lists-content').innerHTML = '';
        lastTreemapCounts = null; analysisData = {};
    }
</script>

<div class="site-footer">
    <p>&copy; <span id="footer-year"></span> K S Lo English. All Rights Reserved.</p>
</div>
<script>document.getElementById('footer-year').textContent = new Date().getFullYear();</script>

</body>
</html>
